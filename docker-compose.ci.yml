version: '3.8'

services:
  # Allure Report Server
  allure-server:
    image: frankescobar/allure-docker-service
    ports:
      - "5050:5050"
    environment:
      CHECK_RESULTS_EVERY_SECONDS: 1
      KEEP_HISTORY: 1
    volumes:
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/default-reports
    profiles:
      - allure

  # API Tests with Allure
  api-tests-allure:
    build: .
    environment:
      # API Configuration
      - BASE_URL=${BASE_URL:-https://fakerestapi.azurewebsites.net}
      
      # Test Configuration
      - TEST_TAGS=${TEST_TAGS:-@happyPath}
      - TEST_RUNNER=${TEST_RUNNER:-TestRunner}
      - PARALLEL_THREADS=${PARALLEL_THREADS:-2}
      
      # Allure Configuration
      - ALLURE_RESULTS_DIR=allure-results
      - ALLURE_REPORT_DIR=allure-report
      
      # Maven Configuration
      - MAVEN_OPTS=-Xmx2g
    volumes:
      # Mount test results and reports
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/allure-report
      - ./target:/app/target
    profiles:
      - ci
      - allure

  # Happy Path Tests with Allure
  happy-path-allure:
    build: .
    environment:
      - BASE_URL=${BASE_URL:-https://fakerestapi.azurewebsites.net}
      - TEST_TAGS=@happyPath
      - TEST_RUNNER=TestRunner
      - PARALLEL_THREADS=${PARALLEL_THREADS:-2}
      - ALLURE_RESULTS_DIR=allure-results
      - ALLURE_REPORT_DIR=allure-report
    volumes:
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/allure-report
      - ./target:/app/target
    profiles:
      - ci
      - allure

  # Edge Cases Tests with Allure
  edge-cases-allure:
    build: .
    environment:
      - BASE_URL=${BASE_URL:-https://fakerestapi.azurewebsites.net}
      - TEST_TAGS=@edgeCases
      - TEST_RUNNER=EdgeCasesRunner
      - PARALLEL_THREADS=${PARALLEL_THREADS:-2}
      - ALLURE_RESULTS_DIR=allure-results
      - ALLURE_REPORT_DIR=allure-report
    volumes:
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/allure-report
      - ./target:/app/target
    profiles:
      - ci
      - allure

  # All Tests with Allure
  all-tests-allure:
    build: .
    environment:
      - BASE_URL=${BASE_URL:-https://fakerestapi.azurewebsites.net}
      - TEST_TAGS=
      - TEST_RUNNER=All
      - PARALLEL_THREADS=${PARALLEL_THREADS:-4}
      - ALLURE_RESULTS_DIR=allure-results
      - ALLURE_REPORT_DIR=allure-report
    volumes:
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/allure-report
      - ./target:/app/target
    profiles:
      - ci
      - allure 